(function(f){var j=function(a){return"undefined"===typeof f[a]?("undefined"!==typeof console&&console.log('Warning: "hdr2d" canvas context not supported ('+a+" needed)"),!1):!0};if(j("HTMLCanvasElement")&&j("ArrayBuffer")&&j("Float32Array")){f.HDR2D_BLEND_SRC=0;f.HDR2D_BLEND_DST=1;f.HDR2D_BLEND_CLEAR=2;f.HDR2D_BLEND_XOR=3;f.HDR2D_BLEND_OVER=4;f.HDR2D_BLEND_IN=5;f.HDR2D_BLEND_OUT=6;f.HDR2D_BLEND_ATOP=7;f.HDR2D_BLEND_DST_OVER=8;f.HDR2D_BLEND_DST_IN=9;f.HDR2D_BLEND_DST_OUT=10;f.HDR2D_BLEND_DST_ATOP=
11;f.HDR2D_BLEND_ADD=12;f.HDR2D_BLEND_SUBTRACT=13;f.HDR2D_BLEND_MULTIPLY=14;f.HDR2D_BLEND_AVERAGE=15;f.HDR2D_BLEND_SCREEN=16;f.HDR2D_BLEND_SOFTLIGHT=17;f.HDR2D_BLEND_HARDLIGHT=18;f.HDR2D_BLEND_OVERLAY=19;j=document.createElement("canvas");j.width=1;j.height=1;var p=j.getContext("2d"),l=p.getImageData(0,0,1,1),m=function(a,c){this.width=a;this.height=c;this.data=new Float32Array(new ArrayBuffer(16*a*c))},h=function(a){this._context=a.getContext.apply(a,["2d"]);this._imageData=this._context.getImageData(0,
0,a.width,a.height);this.imageData=new m(a.width,a.height);this.canvas=a};h.prototype.globalAlpha=1;h.prototype.globalBlendMode=HDR2D_BLEND_OVER;h.prototype.range={r:{low:0,high:255},g:{low:0,high:255},b:{low:0,high:255},a:{low:0,high:255}};h.prototype.getBlendFunction=function(){var a={};a[HDR2D_BLEND_SRC]={component:function(c,b,d){return c*d},alpha:function(c){return c}};a[HDR2D_BLEND_DST]={component:function(c,b,d,a){return b*a},alpha:function(c,b){return b}};a[HDR2D_BLEND_CLEAR]={component:function(){return 0},
alpha:function(){return 0}};a[HDR2D_BLEND_XOR]={component:function(c,b,d,a){return c*d*(1-a)+b*a*(1-d)},alpha:function(c,b){return c+b-2*c*b}};a[HDR2D_BLEND_OVER]={component:function(c,b,d,a){return c*d+b*a*(1-d)},alpha:function(c,b){return c+b-c*b}};a[HDR2D_BLEND_IN]={component:function(c,b,d,a){return c*d*a},alpha:function(c,b){return c*b}};a[HDR2D_BLEND_OUT]={component:function(c,b,d,a){return c*d*(1-a)},alpha:function(c,b){return c*(1-b)}};a[HDR2D_BLEND_ATOP]={component:function(c,b,a,e){return c*
a*e+b*e*(1-a)},alpha:function(c,b){return b}};a[HDR2D_BLEND_DST_OVER]={component:function(c,b,a,e){return b*e+c*a*(1-e)},alpha:function(c,b){return c+b-c*b}};a[HDR2D_BLEND_DST_IN]={component:function(c,b,a,e){return b*e*a},alpha:function(c,b){return c*b}};a[HDR2D_BLEND_DST_OUT]={component:function(c,b,a,e){return b*e*(1-a)},alpha:function(c,b){return b*(1-c)}};a[HDR2D_BLEND_DST_ATOP]={component:function(c,b,a,e){return b*e*a+c*a*(1-e)},alpha:function(c){return c}};a[HDR2D_BLEND_ADD]={component:function(c,
b,a,e){return b*e+c*a},alpha:a[HDR2D_BLEND_OVER].alpha};a[HDR2D_BLEND_SUBTRACT]={component:function(c,b,a,e){return b*e-c*a},alpha:a[HDR2D_BLEND_OVER].alpha};a[HDR2D_BLEND_MULTIPLY]={component:function(c,b,a,e){return c*b/255*a+b*e*(1-a)},alpha:a[HDR2D_BLEND_OVER].alpha};a[HDR2D_BLEND_AVERAGE]={component:function(c,b,a,e){return(c+b)/2*a+b*e*(1-a)},alpha:a[HDR2D_BLEND_OVER].alpha};a[HDR2D_BLEND_SCREEN]={component:function(c,a,d,e){return(255-(Math.round((255-c)*(255-a))>>8))*d+a*e*(1-d)},alpha:a[HDR2D_BLEND_OVER].alpha};
a[HDR2D_BLEND_OVERLAY]={component:function(a,b,d,e){return(128<a?2*b*a/255:255-2*(255-b)*(255-a)/255)*d+b*e*(1-d)},alpha:a[HDR2D_BLEND_OVER].alpha};a[HDR2D_BLEND_SOFTLIGHT]={component:function(a,b,d,e){return(128>b?2*((Math.round(a)>>1)+64)*(b/255):255-2*(255-((Math.round(a)>>1)+64))*(255-b)/255)*d+b*e*(1-d)},alpha:a[HDR2D_BLEND_OVER].alpha};a[HDR2D_BLEND_HARDLIGHT]={component:function(a,b,d,e){return(128>a?2*b*a/255:255-2*(255-b)*(255-a)/255)*d+b*e*(1-d)},alpha:a[HDR2D_BLEND_OVER].alpha};return function(c){return a[c]}}();
h.prototype.setPixel=function(a,c,b){var d=4*(Math.round(a)+Math.round(c)*this.canvas.width),e=this.getBlendFunction(this.globalBlendMode);"undefined"===typeof b.a&&(b.a=255);var k=this.imageData.data[d+3]/255,g=b.a*p.globalAlpha/255;this.imageData.data[d]=e.component(b.r,this.imageData.data[d],g,k);this.imageData.data[d+1]=e.component(b.g,this.imageData.data[d+1],g,k);this.imageData.data[d+2]=e.component(b.b,this.imageData.data[d+2],g,k);this.imageData.data[d+3]=255*e.alpha(g,k);l.data[0]=255*((this.imageData.data[d]-
this.range.r.low)/(this.range.r.high-this.range.r.low));l.data[1]=255*((this.imageData.data[d+1]-this.range.g.low)/(this.range.g.high-this.range.g.low));l.data[2]=255*((this.imageData.data[d+2]-this.range.b.low)/(this.range.b.high-this.range.b.low));l.data[3]=255*((this.imageData.data[d+3]-this.range.a.low)/(this.range.a.high-this.range.a.low));this._context.putImageData(l,a,c)};h.prototype.getPixel=function(a,c){var b=4*(Math.round(a)+Math.round(c)*this.imageData.width);return{r:this.imageData.data[b],
g:this.imageData.data[b+1],b:this.imageData.data[b+2],a:this.imageData.data[b+3]}};h.prototype.getImageData=function(a,c,b,d){if(0===a&&0===c&&b===this.imageData.width&&d===this.imageData.height)return this.imageData;var e=Math.min(b,this.imageData.width-a),k=Math.min(d,this.imageData.height-c),d=a+e,b=c+k,e=new m(e,k),g,f,k=0;for(g=c;g<b;g++)for(c=a;c<d;c++)f=4*(g*this.imageData.width+c),e.data[k++]=this.imageData.data[f],e.data[k++]=this.imageData.data[f+1],e.data[k++]=this.imageData.data[f+2],
e.data[k++]=this.imageData.data[f+3];return e};h.prototype.drawImage=function(a,c,b,d,e){var f=arguments,g=a.width,h=a.height;5<arguments.length&&(g=f[3],h=f[4],c=f[5],b=f[6],d=f[7],e=f[8]);c=c||0;b=b||0;d=d||g;e=e||h;g=document.createElement("canvas");g.width=this.imageData.width;g.height=this.imageData.height;g=g.getContext("2d");g.globalAlpha=1;g.drawImage.apply(g,f);var i,j,l,n,o,f=this.getBlendFunction(this.globalBlendMode),g=g.getImageData(0,0,this.imageData.width,this.imageData.height).data,
h=Math.floor(c);i=Math.floor(b);var m=Math.min(this.imageData.width,Math.ceil(c+d)),q=Math.min(this.imageData.height,Math.ceil(b+e));for(l=i;l<q;l++)for(j=h;j<m;j++)i=4*(l*this.imageData.width+j),o=this.imageData.data[i+3]/255,n=g[i+3]*p.globalAlpha/255,this.imageData.data[i]=f.component(g[i],this.imageData.data[i],n,o),this.imageData.data[i+1]=f.component(g[i+1],this.imageData.data[i+1],n,o),this.imageData.data[i+2]=f.component(g[i+2],this.imageData.data[i+2],n,o),this.imageData.data[i+3]=255*f.alpha(n,
o);this.render()};h.prototype.render=function(){var a=[],c;for(c in this.range)this.range.hasOwnProperty(c)&&a.push(this.range[c]);for(var b=0,d=this.imageData.data.length;b<d;b++)c=a[b%4],this._imageData.data[b]=255*((this.imageData.data[b]-c.low)/(c.high-c.low));this._context.putImageData(this._imageData,0,0)};f.ImageDataHDR=m;f.CanvasRenderingContextHDR2D=h;HTMLCanvasElement.prototype.getContext=function(){var a=HTMLCanvasElement.prototype.getContext;return function(){return"hdr2d"===arguments[0]?
new h(this):a.apply(this,arguments)}}()}})(window);
