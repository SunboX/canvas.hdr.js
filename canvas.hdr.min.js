(function(g){var j=function(a){return"undefined"===typeof g[a]?("undefined"!==typeof console&&console.log('Warning: "hdr2d" canvas context not supported ('+a+" needed)"),!1):!0};if(j("HTMLCanvasElement")&&j("ArrayBuffer")&&j("Float32Array")){g.HDR2D_BLEND_SRC=0;g.HDR2D_BLEND_DST=1;g.HDR2D_BLEND_CLEAR=2;g.HDR2D_BLEND_XOR=3;g.HDR2D_BLEND_OVER=4;g.HDR2D_BLEND_IN=5;g.HDR2D_BLEND_OUT=6;g.HDR2D_BLEND_ATOP=7;g.HDR2D_BLEND_DST_OVER=8;g.HDR2D_BLEND_DST_IN=9;g.HDR2D_BLEND_DST_OUT=10;g.HDR2D_BLEND_DST_ATOP=
11;g.HDR2D_BLEND_ADD=12;g.HDR2D_BLEND_SUBTRACT=13;g.HDR2D_BLEND_MULTIPLY=14;g.HDR2D_BLEND_AVERAGE=15;g.HDR2D_BLEND_SCREEN=16;g.HDR2D_BLEND_SOFTLIGHT=17;g.HDR2D_BLEND_HARDLIGHT=18;g.HDR2D_BLEND_OVERLAY=19;j=document.createElement("canvas");j.width=1;j.height=1;var k=j.getContext("2d").getImageData(0,0,1,1),l=function(a,b){this.width=a;this.height=b;this.data=new Float32Array(new ArrayBuffer(16*a*b))},i=function(a){this._context=a.getContext.apply(a,["2d"]);this._imageData=this._context.getImageData(0,
0,a.width,a.height);this.imageData=new l(a.width,a.height);this.canvas=a};i.prototype.globalAlpha=1;i.prototype.globalBlendMode=HDR2D_BLEND_OVER;i.prototype.range={r:{low:0,high:255},g:{low:0,high:255},b:{low:0,high:255},a:{low:0,high:255}};i.prototype.getBlendFunction=function(){var a={};a[HDR2D_BLEND_SRC]={component:function(b,c,d){return b*d},alpha:function(b){return b}};a[HDR2D_BLEND_DST]={component:function(b,c,d,a){return c*a},alpha:function(b,c){return c}};a[HDR2D_BLEND_CLEAR]={component:function(){return 0},
alpha:function(){return 0}};a[HDR2D_BLEND_XOR]={component:function(b,c,d,a){return b*d*(1-a)+c*a*(1-d)},alpha:function(b,c){return b+c-2*b*c}};a[HDR2D_BLEND_OVER]={component:function(b,c,d,a){return b*d+c*a*(1-d)},alpha:function(b,c){return b+c-b*c}};a[HDR2D_BLEND_IN]={component:function(b,c,d,a){return b*d*a},alpha:function(b,c){return b*c}};a[HDR2D_BLEND_OUT]={component:function(b,c,d,a){return b*d*(1-a)},alpha:function(b,c){return b*(1-c)}};a[HDR2D_BLEND_ATOP]={component:function(b,c,d,a){return b*
d*a+c*a*(1-d)},alpha:function(b,c){return c}};a[HDR2D_BLEND_DST_OVER]={component:function(b,c,a,e){return c*e+b*a*(1-e)},alpha:function(b,c){return b+c-b*c}};a[HDR2D_BLEND_DST_IN]={component:function(b,c,a,e){return c*e*a},alpha:function(b,c){return b*c}};a[HDR2D_BLEND_DST_OUT]={component:function(b,c,a,e){return c*e*(1-a)},alpha:function(b,c){return c*(1-b)}};a[HDR2D_BLEND_DST_ATOP]={component:function(b,c,a,e){return c*e*a+b*a*(1-e)},alpha:function(b){return b}};a[HDR2D_BLEND_ADD]={component:function(b,
c,a,e){return c*e+b*a},alpha:a[HDR2D_BLEND_OVER].alpha};a[HDR2D_BLEND_SUBTRACT]={component:function(b,c,a,e){return c*e-b*a},alpha:a[HDR2D_BLEND_OVER].alpha};a[HDR2D_BLEND_MULTIPLY]={component:function(b,c,a,e){return b*c/255*a+c*e*(1-a)},alpha:a[HDR2D_BLEND_OVER].alpha};a[HDR2D_BLEND_AVERAGE]={component:function(b,c,a,e){return(b+c)/2*a+c*e*(1-a)},alpha:a[HDR2D_BLEND_OVER].alpha};a[HDR2D_BLEND_SCREEN]={component:function(b,a,d,e){return(255-(Math.round((255-b)*(255-a))>>8))*d+a*e*(1-d)},alpha:a[HDR2D_BLEND_OVER].alpha};
a[HDR2D_BLEND_OVERLAY]={component:function(b,a,d,e){return(128<b?2*a*b/255:255-2*(255-a)*(255-b)/255)*d+a*e*(1-d)},alpha:a[HDR2D_BLEND_OVER].alpha};a[HDR2D_BLEND_SOFTLIGHT]={component:function(b,a,d,e){return(128>a?2*((Math.round(b)>>1)+64)*(a/255):255-2*(255-((Math.round(b)>>1)+64))*(255-a)/255)*d+a*e*(1-d)},alpha:a[HDR2D_BLEND_OVER].alpha};a[HDR2D_BLEND_HARDLIGHT]={component:function(a,c,d,e){return(128>a?2*c*a/255:255-2*(255-c)*(255-a)/255)*d+c*e*(1-d)},alpha:a[HDR2D_BLEND_OVER].alpha};return function(b){return a[b]}}();
i.prototype.setPixel=function(a,b,c){var d=4*(Math.round(a)+Math.round(b)*this.imageData.width),e=this.getBlendFunction(this.globalBlendMode);"undefined"===typeof c.a&&(c.a=255);var h=this.imageData.data[d+3]/255,f=c.a*this.globalAlpha/255;this.imageData.data[d]=e.component(c.r,this.imageData.data[d],f,h);this.imageData.data[d+1]=e.component(c.g,this.imageData.data[d+1],f,h);this.imageData.data[d+2]=e.component(c.b,this.imageData.data[d+2],f,h);this.imageData.data[d+3]=255*e.alpha(f,h);this._imageData.data[d]=
k.data[0]=255*((this.imageData.data[d]-this.range.r.low)/(this.range.r.high-this.range.r.low));this._imageData.data[d+1]=k.data[1]=255*((this.imageData.data[d+1]-this.range.g.low)/(this.range.g.high-this.range.g.low));this._imageData.data[d+2]=k.data[2]=255*((this.imageData.data[d+2]-this.range.b.low)/(this.range.b.high-this.range.b.low));this._imageData.data[d+3]=k.data[3]=255*((this.imageData.data[d+3]-this.range.a.low)/(this.range.a.high-this.range.a.low));this._context.putImageData(k,a,b,0,0,
1,1)};i.prototype.getPixel=function(a,b){var c=4*(Math.round(a)+Math.round(b)*this.imageData.width);return{r:this.imageData.data[c],g:this.imageData.data[c+1],b:this.imageData.data[c+2],a:this.imageData.data[c+3]}};i.prototype.getImageData=function(a,b,c,d){if(0===a&&0===b&&c===this.imageData.width&&d===this.imageData.height)return this.imageData;var e=Math.min(c,this.imageData.width-a),h=Math.min(d,this.imageData.height-b),d=a+e,c=b+h,e=new l(e,h),f,g,h=0;for(f=b;f<c;f++)for(b=a;b<d;b++)g=4*(f*this.imageData.width+
b),e.data[h++]=this.imageData.data[g],e.data[h++]=this.imageData.data[g+1],e.data[h++]=this.imageData.data[g+2],e.data[h++]=this.imageData.data[g+3];return e};i.prototype.drawImage=function(a,b,c,d,e){var h=arguments,f=a.width,g=a.height;5<arguments.length&&(f=h[3],g=h[4],b=h[5],c=h[6],d=h[7],e=h[8]);b=b||0;c=c||0;d=d||f;e=e||g;f=document.createElement("canvas");f.width=this.imageData.width;f.height=this.imageData.height;f=f.getContext("2d");f.globalAlpha=1;f.drawImage.apply(f,h);var i,j,k,h=this.getBlendFunction(this.globalBlendMode),
m=f.getImageData(0,0,this.imageData.width,this.imageData.height).data,l=Math.max(0,Math.floor(b)),n=Math.max(0,Math.floor(c)),o=Math.min(this.imageData.width,Math.ceil(b+d)),p=Math.min(this.imageData.height,Math.ceil(c+e));for(i=n;i<p;i++)for(g=l;g<o;g++)f=4*(i*this.imageData.width+g),k=this.imageData.data[f+3]/255,j=m[f+3]*this.globalAlpha/255,this.imageData.data[f]=h.component(m[f],this.imageData.data[f],j,k),this.imageData.data[f+1]=h.component(m[f+1],this.imageData.data[f+1],j,k),this.imageData.data[f+
2]=h.component(m[f+2],this.imageData.data[f+2],j,k),this.imageData.data[f+3]=255*h.alpha(j,k);this.invalidate(l,n,o-l,p-n)};i.prototype.invalidate=function(a,b,c,d){var e,g,f=[this.range.r,this.range.g,this.range.b,this.range.a];"undefined"===typeof a&&(a=0);"undefined"===typeof b&&(b=0);"undefined"===typeof c&&(c=this.imageData.width);"undefined"===typeof d&&(d=this.imageData.height);if(0===a&&0===b&&c===this.imageData.width&&d===this.imageData.height){b=0;for(a=this.imageData.data.length;b<a;b++)c=
f[b%4],this._imageData.data[b]=255*((this.imageData.data[b]-c.low)/(c.high-c.low))}else{c=Math.min(a+c,this.imageData.width);d=Math.min(b+d,this.imageData.height);for(g=b;g<d;g++)for(e=a;e<c;e++)b=4*(g*this.imageData.width+e),this._imageData.data[b]=255*((this.imageData.data[b]-f[0].low)/(f[0].high-f[0].low)),this._imageData.data[b+1]=255*((this.imageData.data[b+1]-f[1].low)/(f[1].high-f[1].low)),this._imageData.data[b+2]=255*((this.imageData.data[b+2]-f[2].low)/(f[2].high-f[2].low)),this._imageData.data[b+
3]=255*((this.imageData.data[b+3]-f[3].low)/(f[3].high-f[3].low))}this._context.putImageData(this._imageData,0,0)};g.ImageDataHDR=l;g.CanvasRenderingContextHDR2D=i;HTMLCanvasElement.prototype.getContext=function(){var a=HTMLCanvasElement.prototype.getContext;return function(){return"hdr2d"===arguments[0]?new i(this):a.apply(this,arguments)}}()}})(window);
